<html lang="zh-hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>

<body>
  <style>
  </style>
  <div class="container-fluid">
    <nav id="navbar" class="navbar navbar-expand-md bg-dark navbar-dark text-white fixed-top">連線失敗</nav>
    <div id="chat" class="h-100"></div>
    <div class="input-group mb-3 fixed-bottom">
      <input type="text" class="form-control" id="txt" placeholder="輸入文字" autocomplete="off">
      <div class="input-group-append">
        <button class="btn btn-success" id="submit">>></button>
      </div>
    </div>
  </div>
  <span id="ip"></span>

  <script>
    var socket = io.connect();
    let name;
    let Ip = "8.8.8.8.7";
    let down = true;
    /*
    $.getJSON('https://ipinfo.io/', function (data) {
      Ip = data.ip;
      socket.on('connect', () => {
        socket.emit('ip', {
          'ip': Ip,
        });
      });
      socket.emit('ip', {
        'ip': Ip,
      });
    });
    */

    socket.on('connect', () => {
      socket.emit('ip', {
        'ip': Ip,
      });
    });

    socket.on('chat', function (data) {
      let str = "";
      for (var i = 0; i < data.chat.length; i++) {
        let speaker = htmlEncode(data.chat[i].name);
        let content = htmlEncode(data.chat[i].text);
        if (data.chat[i].name === "伺服器") {
          str += '<div class="d-flex flex-row"><div class="p-2 bg-danger text-white">' + speaker + '</div><div class="p-2 bg-warning">' + content + '</div></div><br/>';
        } else if (data.chat[i].name == name) {
          str += '<div class="d-flex flex-row-reverse"><div class="p-2 bg-warning">' + content + '</div><div class="p-2 bg-primary text-white">' + speaker + '</div></div><br/>';
        } else {
          str += '<div class="d-flex flex-row"><div class="p-2 bg-info text-white">' + speaker + '</div><div class="p-2 bg-warning">' + content + '</div></div><br/>';
        }
      }
      str += '<br/><br/><br/>';

      $('#chat').html(str);
      if (down && data.news) $("html, body").animate({ scrollTop: document.body.scrollHeight }, "slow");
      if (data.user) {
        name = data.user;
        $('#navbar').html(name);
        window.scrollTo(0, document.body.scrollHeight);
      }
    });

    $(document).ready(function () {
      $('#txt').keydown(function (e) {
        if (e.keyCode === 13) {
          let txt = $("#txt").val();
          if (txt === "") return;
          if (txt.length > 300) return alert("不能多於300個字(" + txt.length + "/300)");
          document.getElementById("txt").value = "";
          socket.emit('client_data', {
            'ip': Ip,
            'text': txt,
          });
        }
      });
    });

      $(window).scroll(function () {
        let scrollBottom = $(document).height() - $(window).height() - $(window).scrollTop();
        //last = $("body").height() - $(window).height() - 50;
        if (scrollBottom<50) {
          down = true;
        } else {
          down = false;
        }
      });

    function htmlEncode(value) {
      return $('<div/>').text(value).html();
    }

    document.getElementById("submit").onclick = function (e) {
      let txt = $("#txt").val();
      if (txt === "") return;
      if (txt.length > 300) return alert("不能多於300個字(" + txt.length + "/300)");
      document.getElementById("txt").value = "";
      socket.emit('client_data', {
        'ip': Ip,
        'text': txt,
      });
    };
  </script>
</body>

</html>